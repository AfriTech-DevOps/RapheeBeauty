name: "Building, Pushing, and Testing Raphee Beauty Docker Images"

on:
  push:
    branches:
      - master
      - dev
      - qa
      - prod
  pull_request:
    branches:
      - master
      - dev
      - qa
      - prod

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Check branch name
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" && ("${{ github.event.pull_request.base.ref }}" != "dev" && "${{ github.event.pull_request.base.ref }}" != "prod" && "${{ github.event.pull_request.base.ref }}" != "qa") ]]; then
              echo "Invalid merge destination. Please merge into dev, prod, or qa only."
              exit 1
          fi

  sonarqube-scan:
    runs-on: ubuntu-latest
    permissions: read-all
    needs: check-branch
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  notifiers-success:
    name: "Send Slack Notification on Success"
    runs-on: ubuntu-latest
    # needs: [check-branch, build-image-dev, build-image-qa, build-image-prod]
    if: always() && success() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2
      - name: "Send Slack Notification"
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"GitHub build results: :white_check_mark: Success \n
          Build on branch ${{ github.ref_name }} has successfully completed. \nCommit SHA: ${{ github.sha }} \n${{ github.event.pull_request.html_url || github.event.head_commit.url }}\"}" ${{ secrets.SLACK_WEBHOOK }}

  notifiers-failure:
    name: "Send Slack Notification on Failure"
    runs-on: ubuntu-latest
    # needs: [check-branch, build-image-dev, build-image-qa, build-image-prod]
    if: always() && failure() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2
      - name: "Send Slack Notification"
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"GitHub build results: :x: Failure \n
          Build on branch  ${{ github.ref_name }} has failed \nCommit SHA: ${{ github.sha }} \n${{ github.event.pull_request.html_url || github.event.head_commit.url }}\"}" ${{ secrets.SLACK_WEBHOOK }}

  notifiers-cancelled:
    name: "Send Slack Notification on Cancelled"
    runs-on: ubuntu-latest
    # needs: [check-branch, build-image-dev, build-image-qa, build-image-prod]
    if: always() && cancelled() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2
      - name: "Send Slack Notification"
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"GitHub build results: :warning: Cancelled \n
          Build on branch  ${{ github.ref_name }} has been canceled \nCommit SHA: ${{ github.sha }} \n${{ github.event.pull_request.html_url || github.event.head_commit.url }}\"}" ${{ secrets.SLACK_WEBHOOK }}
